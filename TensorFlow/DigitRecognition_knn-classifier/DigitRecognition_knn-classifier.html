<!-- 
Author : ChungYi Fu (Kaohsiung, Taiwan)   2019/6/7
https://www.facebook.com/francefu
https://fustyles.github.io/webduino/TensorFlow/DigitRecognition_knn-classifier/DigitRecognition_knn-classifier.html
-->

<html>
  <head>
    <script src='https://fustyles.github.io/webduino/myBlockly/GameElements/gameelements.js'></script>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Load MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <!-- Load KNN classifier -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
 </head>

  <body>
  <input type="file" id="selectimage_train" multiple="true" style="position:absolute;top:30px;visibility:hidden;"></input>
  <input type="file" id="selectimage_load" style="position:absolute;top:30px;visibility:hidden;"></input>
  </body>
  <script>
    button_create('SelectTrain',140,30,0,0,1,null,'Select images to train',0,true);
    button_create('SelectLoad',160,30,140,0,1,null,'Select one image to load',0,true);
    button_create('addExample',100,30,0,30,1,null,'Train Example',0,true);
    select_create('Class',50,30,100,30,'#ffffff','#000000',14,1,[['0', '0'], ['1', '1'], ['2', '2'], ['3', '3'], ['4', '4'], ['5', '5'], ['6', '6'], ['7', '7'], ['8', '8'], ['9', '9']],'',0,true);
    select_set('Class',"value",'0');
    div_create('count',100,30,200,30,"solid",0,'#000000','#ffffff','#ff0000',20,1,'',0,true);
    div_set('count',"innerHTML","0");
    canvas_create('canvas',300,300,0,60,999);
    canvas_set('canvas',"backgroundColor",'#000000');
    button_create('clear',100,30,200,360,1,null,'clear',0,true);
    image_create('example','',300,300,0,0,0,false);
    canvas_set('canvas',"display",false);
    div_create('result',300,30,0,390,"solid",0,'#000000','#ffffff','#ff0000',14,1,'',0,true);
    div_set('result',"innerHTML",'Please wait for loading model.');
    var canvas = document.getElementById(canvas_get('canvas',"id"));
    var context = canvas.getContext("2d"); 
    var clear = document.getElementById(button_get('clear',"id"));
    var predictClass = document.getElementById(button_get('predictClass',"id"));
    var addExample = document.getElementById(button_get('addExample',"id"));
    var example = document.getElementById(image_get('example',"id"));
    var Class = document.getElementById(select_get('Class',"id"));
    var selectimage_train = document.getElementById("selectimage_train");
    var selectimage_load = document.getElementById("selectimage_load");
    var SelectTrain = document.getElementById(button_get('SelectTrain',"id"));
    var SelectLoad = document.getElementById(button_get('SelectLoad',"id"));
    
    var state = false;
    var color = '#ffffff';
    var x0, y0;

    function canvas_mousedown(event) {
      state = state != true;
      x0 = (mouse_coordinate_get("offsetX"));
      y0 = (mouse_coordinate_get("offsetY"));
    };
    canvas.addEventListener("mousedown", canvas_mousedown, true);

    function canvas_mousemove(event) {
      if (state == true) {
        canvas_line('canvas',5,x0,y0,(mouse_coordinate_get("offsetX")),(mouse_coordinate_get("offsetY")),color,0,1);
      }
      x0 = (mouse_coordinate_get("offsetX"));
      y0 = (mouse_coordinate_get("offsetY"));
    };
    canvas.addEventListener("mousemove", canvas_mousemove, true);

    function clear_onclick (event) {
      canvas_clear('canvas');
    };
    clear.addEventListener("click", clear_onclick, true);    
    
    function predictClass_onclick (event) {
      example.onload = function () {
        predictClass(example);
      }
      example.src = canvas.toDataURL('image/jpeg');
    };   
    
    function addExample_onclick (event) {
      example.src = canvas.toDataURL('image/jpeg');
	  addExampleImage(example, Number(Class.value));
	  div_set('count',"innerHTML",Number(div_get('count',"innerHTML"))+1);
    };
    addExample.addEventListener("click", addExample_onclick, true); 

    function SelectTrain_onclick (event) {
      selectimage_train.click();
    };
    SelectTrain.addEventListener("click", SelectTrain_onclick, true); 

    function SelectLoad_onclick (event) {
      selectimage_load.click();
    };
    SelectLoad.addEventListener("click", SelectLoad_onclick, true);
  </script>
  
  <!-- Place your code in the script tag below. You can also use an external .js file -->
  <script>
    var classifier;
    var mobilenetModule;
    
    // Create the classifier.
    classifier = knnClassifier.create();

    // Load mobilenet.
    mobilenet.load().then(Module => {
      mobilenetModule = Module;
      canvas_set('canvas',"display",true);
      div_set('result',"innerHTML",'');
        setInterval(function(){ predictClass_onclick(); }, 200);
    }); 

    function addExampleImage(img,index) {
      // Add MobileNet activations to the model repeatedly for all Classes.
      var Image = tf.browser.fromPixels(img);
      var logits = mobilenetModule.infer(Image, 'conv_preds');
      classifier.addExample(logits, index);
    }
    
    async function predictClass(img) {
      try
      {
        // Make a prediction.
        const Image = tf.browser.fromPixels(img);
        const xlogits = mobilenetModule.infer(Image, 'conv_preds');
        const result = await classifier.predictClass(xlogits);
        //console.log(result);
        var r = "<font color='red'>label : " + result.label + "</font><br><br>";;
        for (i=0;i<Class.length;i++) {
              r += "["+i+"] " + result.confidences[i.toString()] + "<br>";
        }
        div_set('result',"innerHTML",r); 
      }
      catch (e)
      {
      }
    }

    selectimage_train.onchange = function (event) {
      var target = event.target || window.event.srcElement;
      var files = target.files;
      if (files && files.length>0) 
        ImportMultiFiles(files);
    }

    function ImportMultiFiles(files) {
      function ImportOneFile(n, files) {
        var fr = new FileReader();
        fr.onload = function() { 
          var img = new Image();
          img.onload = function () {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height);
        	addExample.click();
        	console.log(n);
            if (n<(files.length-1)) {
              //ImportOneFile(n+1, files);
        	  setTimeout(function(){ ImportOneFile(n+1, files); }, 2000);
        	}
        	else
        	  return;
          }
          img.src = fr.result;
        }
        fr.readAsDataURL(files[n]);
      }
      ImportOneFile(0, files);
    }

    selectimage_load.onchange = function (event) {
      var target = event.target || window.event.srcElement;
      var files = target.files;
      if (FileReader && files && files.length) {
        var fr = new FileReader();
        fr.onload = function () {
          var img = new Image();
          img.onload = function () {
            context.clearRect(0, 0, canvas.width, canvas.height);
            context.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height);
          }
          img.src = fr.result;
        }
        fr.readAsDataURL(files[0]);
      }
    }
  </script>
</html>
