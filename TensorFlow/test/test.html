<html>
  <head>
    <script src='https://fustyles.github.io/webduino/myBlockly/GameElements/gameelements.js'></script>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <!-- Load MobileNet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <!-- Load KNN Classifier -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/knn-classifier"></script>
 </head>

  <body>
    <select id="class">
      <option value="0">0</option>
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
      <option value="7">7</option>
      <option value="8">8</option>
      <option value="9">9</option>
    </select>  
    <div id="result"></div>
    <img id="test" style="position:absolute;left:0px;top:200px;width:100px;height:100px">
    <div id="sample"></div>
  </body>
  <script>
    var state, x0, color, y0;
    button_create('addExample',100,30,50,0,1,null,'addExample',0,true);
    button_create('predictClass',100,30,150,0,1,null,'predictClass',0,true);
    button_create('clear',100,30,250,0,1,null,'clear',0,true);
    canvas_create('canvas',100,100,0,400,9999);
    document.getElementById(canvas_get('canvas',"id")).style = "border: 1px solid black;";
    
    state = false;
    color = '#000000';

    function canvas_mousedown(event) {
      state = state != true;
      x0 = (mouse_coordinate_get("offsetX"));
      y0 = (mouse_coordinate_get("offsetY"));
    };
    document.getElementById(canvas_get('canvas',"id")).addEventListener("mousedown", canvas_mousedown, true);

    function canvas_mousemove(event) {
      if (state == true) {
        canvas_line('canvas',5,x0,y0,(mouse_coordinate_get("offsetX")),(mouse_coordinate_get("offsetY")),color,0,1);
      }
      x0 = (mouse_coordinate_get("offsetX"));
      y0 = (mouse_coordinate_get("offsetY"));
    };
    document.getElementById(canvas_get('canvas',"id")).addEventListener("mousemove", canvas_mousemove, true);

    function gamebutton_clear_onclick (event) {
      canvas_clear('canvas');
    };
    gamebutton_clear.addEventListener("click", gamebutton_clear_onclick, true);    
    
    function gamebutton_predictClass_onclick (event) {
      document.getElementById("test").onload = function () {
        predictClass(document.getElementById("test"));
      }      
      document.getElementById("test").src = document.getElementById(canvas_get('canvas',"id")).toDataURL();
    };
    gamebutton_predictClass.addEventListener("click", gamebutton_predictClass_onclick, true);     
    
    function gamebutton_addExample_onclick (event) {
      document.getElementById("test").onload = function () {
        addExampleImage(document.getElementById("test"), Number(document.getElementById("class").value));
      }      
      document.getElementById("test").src = document.getElementById(canvas_get('canvas',"id")).toDataURL();
    };
    gamebutton_addExample.addEventListener("click", gamebutton_addExample_onclick, true);      
  </script>
  
  <!-- Place your code in the script tag below. You can also use an external .js file -->
  <script>

    var classifier;
    var mobilenetModule;
    
    // Create the classifier.
    classifier = knnClassifier.create();

    // Load mobilenet.
    mobilenet.load().then(Module => {
      mobilenetModule = Module;
      document.getElementById("result").innerHTML = "Ready!";
      //predictClass(document.getElementById("test"));
    }); 

    function addExampleImage(img,index) {
      // Add MobileNet activations to the model repeatedly for all classes.
      var Image = tf.browser.fromPixels(img);
      var logits = mobilenetModule.infer(Image, 'conv_preds');
      classifier.addExample(logits, index);
      
      var s = new image();
      s.src = img.src;
      s.width = 30;
      s.height = 30;
      document.getElementById("sample").appendChild(s);
    }
    
    async function predictClass(img) {
      // Make a prediction.
      const Image = tf.browser.fromPixels(img);
      const xlogits = mobilenetModule.infer(Image, 'conv_preds');
      const result = await classifier.predictClass(xlogits);
      console.log(result);
      document.getElementById("result").innerHTML = result.label;    
    }
  </script>
</html>
