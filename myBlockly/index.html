<!-- Author: Chung-Yi Fu (Kaohsiung, Taiwan)   https://www.facebook.com/francefu      Update: 2018-12-28 -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>myBlockly</title>
  <script>
	var script_blockly = [
		'https://blockly-demo.appspot.com/static/blockly_compressed.js',
		'https://blockly-demo.appspot.com/static/blocks_compressed.js',
		'https://blockly-demo.appspot.com/static/javascript_compressed.js',
		'https://fustyles.github.io/webduino/myBlockly/toolbox.js',

		'https://fustyles.github.io/webduino/myBlockly/example/Game_Tetris.js',
		'https://fustyles.github.io/webduino/myBlockly/example/Matrixled_Marquee_iloveyou.js',

		'https://fustyles.github.io/webduino/myBlockly/ShowText/blocks_ShowText.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/javascript_ShowText.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/toolbox_ShowText.js',

		'https://fustyles.github.io/webduino/myBlockly/Keyboard/blocks_Keyboard.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/javascript_Keyboard.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/toolbox_Keyboard.js',
		
		'https://fustyles.github.io/webduino/myBlockly/Instruction/blocks_Instruction.js',
		'https://fustyles.github.io/webduino/myBlockly/Instruction/javascript_Instruction.js',
		'https://fustyles.github.io/webduino/myBlockly/Instruction/toolbox_Instruction.js',
		
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/blocks_MatrixLed.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/javascript_MatrixLed.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/toolbox_MatrixLed.js',
		
		'https://fustyles.github.io/webduino/myBlockly/GameElements/blocks_GameElements.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/javascript_GameElements.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/toolbox_GameElements.js',
		
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/blocks_OpenURL.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/javascript_OpenURL.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/toolbox_OpenURL.js',
		
		'https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js'
	];
	for (var i=0;i<script_blockly.length;i++) {
	  document.write("\<script src='"+script_blockly[i]+"'\>\<\/script>");
	}
	var language = location.search.toLowerCase();
	if (language.indexOf("lang=zh-hant")!=-1)
	{
		var script_msg = [
		'https://fustyles.github.io/webduino/myBlockly/zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/msg_ShowText_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/msg_Keyboard_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/msg_MatrixLed_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/msg_GameElements_zh-hant.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/msg_OpenURL_zh-hant.js'
		];
	} else{
		var script_msg = [
		'https://fustyles.github.io/webduino/myBlockly/en.js',
		'https://fustyles.github.io/webduino/myBlockly/ShowText/msg_ShowText.js',
		'https://fustyles.github.io/webduino/myBlockly/Keyboard/msg_Keyboard.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/msg_MatrixLed.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/msg_GameElements.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/msg_OpenURL.js'
		];
	}
	for (var i=0;i<script_msg.length;i++) {
	  document.write("\<script src='"+script_msg[i]+"'\>\<\/script>");
	}
	var script_iframe_run = [
		'https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js',
		'https://fustyles.github.io/webduino/myBlockly/MatrixLed/matrixled.js',
		'https://fustyles.github.io/webduino/myBlockly/GameElements/gameelements.js',
		'https://fustyles.github.io/webduino/myBlockly/OpenURL/openurl.js'
	];
  </script>
</head>
<body>

<table>
  <tr>
    <td rowspan="4" align="left" valign="center">
      <div id="blocklyDiv" style="height: 620px; width: 950px;"></div>
    </td>
    <td align="left" valign="center">
      <button onclick="document.getElementById('btnRun').disabled=true;runCode();">Show Screen</button>
      left<input type="text" id="ifrLeft" size="1" value="500" onfocus="this.select()">top<input type="text" id="ifrTop" size="1" value="20" onfocus="this.select()">width<input type="text" id="ifrWidth" size="1" value="350" onfocus="this.select()">height<input type="text" id="ifrHeight" size="1" value="545" onfocus="this.select()">
    </td>
  </tr>
  <tr>
    <td  align="left" valign="center">
	  <button onclick="exportBlocks()">Export Blocks</button>
    </td>
  </tr>
  <tr>
    <td align="left" valign="center">
      <button onclick="importBlocks()">Import Blocks</button>
      <select onchange="if (this.value!='') XmldomToWorkspace(eval(this.value));this.value='';">
        <option value=""></option>
	    <option value="Game_Tetris">Game_Tetris</option>
	    <option value="Matrixled_Marquee_iloveyou">Matrixled_Marquee_iloveyou</option>
      </select>
    </td>
  </tr>
  <tr>
   <td>
      <textarea id="javscriptArea"  cols="50" rows="36" readonly></textarea>
    </td>
  </tr>
</table>

<div id="runArea" style="left:250px;top:10px;position:absolute;display:none;z-index:9999">
  <button onclick="document.getElementById('btnRun').disabled=true;runCode();" id="btnRun">Run Code</button><button onclick="document.getElementById('btnRun').disabled=false;stopCode();">Stop Code</button><button onclick="closeScreen();">Close Screen</button>
  <br>
  <iframe id="iframe_run" style="width:600px;height:600px;background-color: white" frameborder="1"  scrolling="auto" allow="geolocation; microphone; camera"></iframe>
</div>

<xml id="toolbox" style="display: none"></xml>
<xml id="startBlocks" style="display: none"></xml>

<script>
//append category to toolbox
var category = [
	catSystem,
	"<category></category>",
	catShowText,
	catKeyboard,
	catInstruction,
	catGameElements,
	catMatrixLed,
	catOpenURL
].join("");
while (category.toLowerCase().indexOf("<category")!=-1) {
  var s = category.toLowerCase().indexOf("<category");
  var e = category.toLowerCase().indexOf("</category>");
  var xml = Blockly.Xml.textToDom("<xml>"+category.substring(s,e+11)+"</xml>");
  document.getElementById('toolbox').append(xml.firstChild);
  category=category.substr(e+11);
}
	
var demoWorkspace = Blockly.inject('blocklyDiv',{media: '../../media/', toolbox: document.getElementById('toolbox')});
Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),demoWorkspace);

//append Game(Tetris) blocks to startBlocks
XmldomToWorkspace(Game_Tetris);

function XmldomToWorkspace(example) {	
	var xml = Blockly.Xml.textToDom(example);
	demoWorkspace.clear();
	Blockly.Xml.domToWorkspace(xml, demoWorkspace);
}	

function showCode() {
  Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
  var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
  document.getElementById('javscriptArea').innerHTML = code;
}
demoWorkspace.addChangeListener(showCode);
	
function runCode() {
  window.LoopTrap = 1000;
  Blockly.JavaScript.INFINITE_LOOP_TRAP =
  'if (--window.LoopTrap == 0) throw "Infinite loop.";\n';
  var code = Blockly.JavaScript.workspaceToCode(demoWorkspace);
  var iframe_code="\<html\>\<head\>\<meta charset='utf-8'\>";
  for (var i=0;i<script_iframe_run.length;i++)
  {
    iframe_code += "\<script src='"+script_iframe_run[i]+"'\>\<\/script>";
  }
  iframe_code += "\<\/head\>\<body\>  \<div id='showText'\>\<\div>\<script\>" + code + "\<\/script\>\<\/body\>\<\/html\>";
  Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
  try {
    document.getElementById("runArea").style.left = document.getElementById("ifrLeft").value + "px";
    document.getElementById("runArea").style.top = document.getElementById("ifrTop").value + "px";
    document.getElementById("iframe_run").style.width = document.getElementById("ifrWidth").value + "px";
    document.getElementById("iframe_run").style.height = document.getElementById("ifrHeight").value + "px";
    document.getElementById("runArea").style.display = "block";
    document.getElementById("iframe_run").src = 'data:text/html;charset=utf-8,' + encodeURI(iframe_code);
    document.getElementById("iframe_run").focus();
  } catch (e) {
    alert(e);
  }
}
	
function stopCode() {
  try {	
    document.getElementById("iframe_run").src='data:text/html;charset=utf-8,';
  } catch (e) {
    alert(e);
  }
}
	
function closeScreen() {
  try {	
    document.getElementById("iframe_run").src='data:text/html;charset=utf-8,';	  
    document.getElementById("runArea").style.display = "none";
  } catch (e) {
    alert(e);
  }	  
}
	
function exportBlocks() {
  try {
    var xml = Blockly.Xml.workspaceToDom(demoWorkspace);
    var xml_text = Blockly.Xml.domToText(xml);
    window.location.href="data:application/octet-stream;utf-8," + encodeURI(xml_text);
  } catch (e) {
    alert(e);
  }
}
	
function importBlocks() {
  try {
    var xml_text = prompt("Please enter XML code", "");
    var xml = Blockly.Xml.textToDom(xml_text);
    demoWorkspace.clear();
    Blockly.Xml.domToWorkspace(xml, demoWorkspace);
  } catch (e) {
    alert(e);
  }
}
</script>

</body>
</html>
